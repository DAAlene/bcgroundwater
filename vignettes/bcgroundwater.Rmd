---
title: "Using the bcgroundwater package"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{bcgroundwater}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r set-options, echo=FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4)
```

First, decide which well is your well of interest from the B.C. Observation Well
Network [interactive map tool](http://www.env.gov.bc.ca/wsd/data_searches/obswell/map/obsWells.html).

Here we will work with data from Observation Well **309**.

First load the package:

```{r}
library(bcgroundwater)
```

Now you can download data on the well (this make take a few moments).

If you are interested in daily averages, specify `which = "daily"`

```{r}
daily_data <- get_gwl(wells = 309, which = "daily")
head(daily_data)
```

If you are interested only in recent hourly data (within the last two years), specify `which = "recent"`

```{r}
recent_data <- get_gwl(wells = 309, which = "recent")
head(recent_data)
```

Otherwise, by default `which = "all"` which downloads all hourly data for that well:

```{r}
data <- get_gwl(wells = 309)
head(data)
```

Next, calculate the median monthly values:

```{r}
monthly_data <- monthlyValues(data)
head(monthly_data)
```

You can plot the seasonal patterns in the water levels of the well with
`gwlMonthlyPlot()`. This displays the mean deviation from the yearly average,
as well as the range of variation:

```{r}
monthlyplot <- gwlMonthlyPlot(monthly_data, last12 = TRUE)
plot(monthlyplot)
```

To perform the analysis, you will need to generate a full regular time series
with no gaps in the dates. `makeWellTS()` does this for you, interpolating the
missing values:

```{r, fig.width=6, fig.height=4}
full_monthly_data <- makeWellTS(monthly_data)
head(monthly_data)
```

For trend analysis over a long time series, it is often beneficial to test for
trends with yearly averages, otherwise serial autocorrelation can be a problem
(even with pre-whitening). These can be calculated easily using the `dplyr`
package:

```{r}
library(dplyr)

annual_data <- full_monthly_data %>%
  select(-yearmonth) %>%
  group_by(EMS_ID, Well_Num, Year) %>%
  summarize(nReadings = n(),
            mean_GWL = mean(med_GWL),
            SD = sd(med_GWL),
            med_GWL = median(med_GWL),
            q95_GWL = quantile(med_GWL, 0.95))
```

You can now calculate the trend:

```{r}
trends <- gwlZypTest(annual_data, byID = "Well_Num", col = "mean_GWL")
trends
```

Finally, plot the time series with the trend overlaid (we will use the results
from the yuepilon method), optionally with interpolated values overlaid:

```{r, warning=FALSE}
trend_plot <- gwlAreaPlot(full_monthly_data, trend = trends$trend[1],
                          intercept = trends$intercept[1], sig = trends$sig[1],
                          state = "Stable", mkperiod = "annual", showInterpolated = TRUE)
plot(trend_plot)

```

